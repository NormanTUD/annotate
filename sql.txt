create database if not exists annotate;
use annotate;
CREATE TABLE IF NOT EXISTS image (id INT UNSIGNED PRIMARY KEY AUTO_INCREMENT, filename VARCHAR(200) UNIQUE, width INT UNSIGNED, height INT UNSIGNED, deleted INT UNSIGNED DEFAULT 0, offtopic INT UNSIGNED DEFAULT 0, perception_hash VARCHAR(50) DEFAULT NULL, unidentifiable INT DEFAULT 0, INDEX idx_image (id, filename, width, height, perception_hash, deleted), INDEX idx_image_deleted_offtopic_perception_hash_id (deleted, offtopic, perception_hash, id), INDEX image_filename (filename)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
CREATE TABLE IF NOT EXISTS category (id INT UNSIGNED PRIMARY KEY AUTO_INCREMENT, name VARCHAR(200) UNIQUE, INDEX idx_category (id, name)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
CREATE TABLE IF NOT EXISTS user (id INT UNSIGNED PRIMARY KEY AUTO_INCREMENT, name VARCHAR(200) UNIQUE) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
CREATE TABLE IF NOT EXISTS annotation (id INT UNSIGNED PRIMARY KEY AUTO_INCREMENT, image_id INT UNSIGNED, user_id INT UNSIGNED, category_id INT UNSIGNED, x_start INT UNSIGNED, y_start INT UNSIGNED, w INT UNSIGNED, h INT UNSIGNED, json VARCHAR(5000), annotarius_id VARCHAR(200) UNIQUE, modified TIMESTAMP DEFAULT CURRENT_TIMESTAMP, deleted INT UNSIGNED DEFAULT 0, curated INT UNSIGNED DEFAULT NULL, model_uuid VARCHAR(100) DEFAULT NULL, FOREIGN KEY (category_id) REFERENCES category(id) ON DELETE CASCADE, FOREIGN KEY (user_id) REFERENCES user(id) ON DELETE CASCADE, FOREIGN KEY (image_id) REFERENCES image(id) ON DELETE CASCADE, INDEX idx_annotation (image_id, category_id, deleted, x_start, y_start, w, h, id, modified), INDEX annotation_image_id (image_id)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
CREATE TABLE IF NOT EXISTS image_data (id INT UNSIGNED NOT NULL AUTO_INCREMENT, filename VARCHAR(255) NOT NULL UNIQUE, image_content LONGBLOB, PRIMARY KEY (id)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
CREATE TABLE IF NOT EXISTS models (id INT AUTO_INCREMENT PRIMARY KEY, model_name VARCHAR(100) NOT NULL, upload_time TIMESTAMP, filename VARCHAR(100), file_contents LONGBLOB, uuid VARCHAR(100) NOT NULL, UNIQUE KEY unique_models_uid (filename, uuid)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
CREATE TABLE IF NOT EXISTS model_labels (id INT UNSIGNED NOT NULL AUTO_INCREMENT, model_id INT NOT NULL, label_index INT UNSIGNED NOT NULL, label_name VARCHAR(255) NOT NULL, PRIMARY KEY (id), UNIQUE KEY unique_model_label (model_id, label_index), FOREIGN KEY (model_id) REFERENCES models(id) ON DELETE CASCADE) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
ALTER TABLE image ADD COLUMN IF NOT EXISTS filename VARCHAR(200) UNIQUE, ADD COLUMN IF NOT EXISTS width INT UNSIGNED, ADD COLUMN IF NOT EXISTS height INT UNSIGNED, ADD COLUMN IF NOT EXISTS deleted INT UNSIGNED DEFAULT 0, ADD COLUMN IF NOT EXISTS offtopic INT UNSIGNED DEFAULT 0, ADD COLUMN IF NOT EXISTS perception_hash VARCHAR(50) DEFAULT NULL, ADD COLUMN IF NOT EXISTS unidentifiable INT DEFAULT 0;
CREATE INDEX IF NOT EXISTS idx_image ON image (id, filename, width, height, perception_hash, deleted);
CREATE INDEX IF NOT EXISTS idx_image_deleted_offtopic_perception_hash_id ON image (deleted, offtopic, perception_hash, id);
CREATE INDEX IF NOT EXISTS image_filename ON image (filename);
ALTER TABLE category ADD COLUMN IF NOT EXISTS name VARCHAR(200) UNIQUE;
CREATE INDEX IF NOT EXISTS idx_category ON category (id, name);
ALTER TABLE user ADD COLUMN IF NOT EXISTS name VARCHAR(200) UNIQUE;
ALTER TABLE annotation ADD COLUMN IF NOT EXISTS image_id INT UNSIGNED, ADD COLUMN IF NOT EXISTS user_id INT UNSIGNED, ADD COLUMN IF NOT EXISTS category_id INT UNSIGNED, ADD COLUMN IF NOT EXISTS x_start INT UNSIGNED, ADD COLUMN IF NOT EXISTS y_start INT UNSIGNED, ADD COLUMN IF NOT EXISTS w INT UNSIGNED, ADD COLUMN IF NOT EXISTS h INT UNSIGNED, ADD COLUMN IF NOT EXISTS json VARCHAR(5000), ADD COLUMN IF NOT EXISTS annotarius_id VARCHAR(200) UNIQUE, ADD COLUMN IF NOT EXISTS modified TIMESTAMP DEFAULT CURRENT_TIMESTAMP, ADD COLUMN IF NOT EXISTS deleted INT UNSIGNED DEFAULT 0, ADD COLUMN IF NOT EXISTS curated INT UNSIGNED DEFAULT NULL, ADD COLUMN IF NOT EXISTS model_uuid VARCHAR(100) DEFAULT NULL;
CREATE INDEX IF NOT EXISTS idx_annotation ON annotation (image_id, category_id, deleted, x_start, y_start, w, h, id, modified);
CREATE INDEX IF NOT EXISTS annotation_image_id ON annotation (image_id);
ALTER TABLE models ADD COLUMN IF NOT EXISTS model_name VARCHAR(100) NOT NULL, ADD COLUMN IF NOT EXISTS upload_time TIMESTAMP, ADD COLUMN IF NOT EXISTS filename VARCHAR(100), ADD COLUMN IF NOT EXISTS file_contents LONGBLOB, ADD COLUMN IF NOT EXISTS uuid VARCHAR(100) NOT NULL;
CREATE UNIQUE INDEX IF NOT EXISTS unique_models_uid ON models (filename, uuid);
ALTER TABLE model_labels ADD COLUMN IF NOT EXISTS model_id INT NOT NULL, ADD COLUMN IF NOT EXISTS label_index INT UNSIGNED NOT NULL, ADD COLUMN IF NOT EXISTS label_name VARCHAR(255) NOT NULL;
CREATE UNIQUE INDEX IF NOT EXISTS unique_model_label ON model_labels (model_id, label_index);
CREATE TABLE IF NOT EXISTS image_versions (id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY, image_id INT UNSIGNED NOT NULL, version INT UNSIGNED NOT NULL, modification_type VARCHAR(50), image_content LONGBLOB NOT NULL, created TIMESTAMP DEFAULT CURRENT_TIMESTAMP, FOREIGN KEY (image_id) REFERENCES image(id) ON DELETE CASCADE, UNIQUE KEY uniq_image_version (image_id, version));

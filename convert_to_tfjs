#!/bin/bash

# Name des YOLO-Modells und Ausgabepfad als Parameter
model_file=$1
output_dir_host=$2

# Pr체fen ob beide Parameter angegeben wurden
if [[ -z "$model_file" || -z "$output_dir_host" ]]; then
    echo "Usage: $0 <model_file> <output_dir>"
    exit 1
fi

bash check_docker_group_current_user

function ensure_docker {
    if ! command -v docker &> /dev/null; then
        echo "Docker not found. Attempting to install..."
        if ! command -v apt-get &> /dev/null; then
            echo "apt-get not found. Cannot install Docker automatically."
            exit 1
        fi
        sudo apt-get update || { echo "apt-get update failed"; exit 1; }
        sudo apt-get install -y curl gnupg lsb-release || { echo "Failed to install prerequisites"; exit 1; }
        curl -fsSL https://get.docker.com | sudo bash || { echo "Docker installation failed"; exit 1; }
        if ! command -v docker &> /dev/null; then
            echo "Docker installation failed or not in PATH."
            exit 1
        fi
        echo "Docker successfully installed."
    fi
}

# Docker sicherstellen
ensure_docker

# Absoluter Pfad des Modells
model_file=$(realpath "$model_file")
if [[ ! -f "$model_file" ]]; then
    echo "Model file $model_file does not exist."
    exit 1
fi

# Absoluter Pfad des Ausgabeverzeichnisses
output_dir_host=$(realpath "$output_dir_host")
mkdir -p "$output_dir_host" || { echo "Cannot create output directory $output_dir_host"; exit 1; }

# Tempor채res Verzeichnis f체r Dockerfile
tmp_dir=$(mktemp -d /tmp/convert_tfjs_XXXX)
dockerfile_path="$tmp_dir/Dockerfile"

# Dockerfile schreiben
cat > "$dockerfile_path" <<EOF
FROM python:3.10-slim

RUN apt-get update && \
    apt-get install -y --no-install-recommends build-essential curl libgl1 libglib2.0-0 && \
    rm -rf /var/lib/apt/lists/*

RUN python -m pip install --upgrade pip
RUN python -m pip install ultralytics==8 jax[cpu]==0.4.13 tensorflow-cpu==2.12.0 tensorflowjs==4.7.0

WORKDIR /app
EOF

# Docker-Image bauen
image_tag="yolo_tfjs_temp:latest"
docker build -t "$image_tag" -f "$dockerfile_path" "$tmp_dir" || { echo "Docker build failed"; exit 1; }

# Container ausf체hren und YOLO exportieren
docker run --rm \
    -v "$output_dir_host":/app/output \
    -v "$(dirname "$model_file")":/app/models \
    "$image_tag" /bin/bash -c "
set -e
cd /app
model_filename=\"$(basename "$model_file")\"
if [[ -f /app/models/\$model_filename ]]; then
    echo '======'
    echo 'Exporting YOLO model to TFJS format...'
    echo '======'
    yolo export model=/app/models/\$model_filename format=tfjs output=/app/output
else
    echo 'Model file /app/models/\$model_filename not found'
    exit 1
fi
"

echo "WEB_MODEL: $output_dir_host"
exit 0

#!/bin/bash

# Name des YOLO-Modells als Parameter
model_file=$1

if [[ -z "$model_file" ]]; then
	echo "Usage: $0 <model_file>"
	exit 1
fi

# Funktion zum Prüfen und ggf. Installieren von Docker
function ensure_docker {
	if ! command -v docker &> /dev/null; then
		echo "Docker not found. Attempting to install..."

		# Prüfen ob apt vorhanden ist
		if ! command -v apt-get &> /dev/null; then
			echo "apt-get not found. Cannot install Docker automatically."
			exit 1
		fi

		# Installieren von Abhängigkeiten
		sudo apt-get update || { echo "apt-get update failed"; exit 1; }
		sudo apt-get install -y curl gnupg lsb-release || { echo "Failed to install prerequisites"; exit 1; }

		# Docker installieren über offiziellen Installer
		curl -fsSL https://get.docker.com | sudo bash || { echo "Docker installation failed"; exit 1; }

		# Prüfen ob Installation erfolgreich war
		if ! command -v docker &> /dev/null; then
			echo "Docker installation failed or not in PATH."
			exit 1
		fi

		echo "Docker successfully installed."
	fi
}

# Docker sicherstellen
ensure_docker

# Absoluter Pfad des Modells
model_file=$(realpath "$model_file")
if [[ ! -f "$model_file" ]]; then
	echo "Model file $model_file does not exist."
	exit 1
fi

# Temporäres Verzeichnis
tmp_dir=$(mktemp -d /tmp/convert_tfjs_XXXX)
dockerfile_path="$tmp_dir/Dockerfile"
output_dir="$tmp_dir/output"

mkdir -p "$output_dir"

# Temporäre Dockerfile schreiben
cat > "$dockerfile_path" <<EOF
FROM python:3.10-slim

RUN apt-get update && \\
    apt-get install -y --no-install-recommends build-essential curl && \\
    rm -rf /var/lib/apt/lists/*

RUN python -m pip install --upgrade pip

RUN python -m pip install \\
    tensorflow==2.12.0 \\
    tensorflowjs==4.7.0 \\
    jax==0.4.13 \\
    jaxlib==0.4.13 \\
    ultralytics

RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        build-essential \
        curl \
        libgl1 \
        libglib2.0-0 && \
    rm -rf /var/lib/apt/lists/*


WORKDIR /app
EOF

# Docker-Image bauen
image_tag="yolo_tfjs_temp:latest"
docker build -t "$image_tag" -f "$dockerfile_path" "$tmp_dir" || { echo "Docker build failed"; exit 1; }

# Container ausführen und YOLO exportieren
docker run --rm -v "$output_dir":/app/output -v "$(dirname "$model_file")":/app/models "$image_tag" /bin/bash -c "
set -e
cd /app
yolo export model=/app/models/$(basename "$model_file") format=tfjs output=/app/output
" || { echo "YOLO export failed"; exit 1; }

# Ergebnis ausgeben
echo "TFJS model saved at: $output_dir"
exit 0

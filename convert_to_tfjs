#!/bin/bash

# Name des YOLO-Modells als Parameter
model_file=$1

if [[ -z "$model_file" ]]; then
    echo "Usage: $0 <model_file>"
    exit 1
fi

# Pr체fen, ob Docker installiert ist
if ! command -v docker &> /dev/null; then
    echo "Docker is not installed. Aborting."
    exit 1
fi

# Absoluter Pfad des Modells
model_file=$(realpath "$model_file")
if [[ ! -f "$model_file" ]]; then
    echo "Model file $model_file does not exist."
    exit 1
fi

# Tempor채res Verzeichnis
tmp_dir=$(mktemp -d /tmp/convert_tfjs_XXXX)
dockerfile_path="$tmp_dir/Dockerfile"
output_dir="$tmp_dir/output"

mkdir -p "$output_dir"

# Tempor채re Dockerfile schreiben
cat > "$dockerfile_path" <<EOF
FROM python:3.10-slim

RUN apt-get update && \\
    apt-get install -y --no-install-recommends build-essential curl && \\
    rm -rf /var/lib/apt/lists/*

RUN python -m pip install --upgrade pip

RUN python -m pip install \\
    tensorflow==2.12.0 \\
    tensorflowjs==4.7.0 \\
    jax==0.4.13 \\
    jaxlib==0.4.13 \\
    ultralytics

WORKDIR /app
EOF

# Docker-Image bauen
image_tag="yolo_tfjs_temp:latest"
docker build -t "$image_tag" -f "$dockerfile_path" "$tmp_dir" || { echo "Docker build failed"; exit 1; }

# Container ausf체hren und YOLO exportieren
docker run --rm -v "$output_dir":/app/output -v "$(dirname "$model_file")":/app/models "$image_tag" /bin/bash -c "
    set -e
    cd /app
    yolo export model=/app/models/$(basename "$model_file") format=tfjs output=/app/output
" || { echo "YOLO export failed"; exit 1; }

# Ergebnis ausgeben
echo "TFJS model saved at: $output_dir"
exit 0
